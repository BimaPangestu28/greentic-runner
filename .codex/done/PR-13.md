# PR-13.md (greentic-runner)
# Title: Support running materialized packs with external components (no OCI fetching)

## Context
Distributor-client 0.4 can resolve OCI component refs and materialize them locally. Runner should stay registry-free but be able to execute packs when components are already materialized on disk.

## Goals
1) Allow running a pack from a materialized pack directory (or a gtpack + component map) where components are local files.  
2) Resolve components deterministically from local paths: prefer materialized components, fall back to embedded gtpack artifacts, and error clearly if missing.  
3) Keep runner free of OCI fetch/cache logic.

## Current behavior (audit)
- Pack loading entrypoint: `PackRuntime::load` (crates/greentic-runner-host/src/pack.rs). It reads `.gtpack` archives (uses `load_manifest_and_flows` + `load_components_from_archive` expecting `components/<id>.wasm`) or a single `.wasm` path. No support for external component paths.  
- Pack ingestion via watcher: `watcher.rs` calls `PackRuntime::load(record.main.path, archive_source=record.main.path, verify=true)` where `record.main.path` is a cached `.gtpack`.  
- Desktop CLI: `run_pack_async` extracts the first component from a `.gtpack` via `resolve_component_artifact`, then calls `PackRuntime::load(component_artifact, archive_source=pack_path, …)`. Again, only embedded components are used.

## Plan sketch
- Accept a “materialized pack” layout (directory) that contains `manifest.cbor` and `components/<id>.wasm` (produced by distributor-client). Optionally keep support for `.gtpack` + sidecar component map.  
- Update `PackRuntime::load` to load manifests/flows from dir/gtpack and build the component map by preferring materialized components over archive entries.  
- Extend CLI/desktop surface (and watcher config if needed) to accept a pack directory flag/option and wire the component directory through to `PackRuntime::load`.  
- Add tests covering: prefer materialized component, fallback to embedded when missing, error when neither. No OCI fetch logic added.

## Design notes
- Chose option A (materialized pack dir) with an optional override map: `ComponentResolution` now prefers overrides -> materialized dir -> archive entries and errors loudly when missing.  
- Desktop CLI exposes `--components-dir` / `--components-map` so distributor-client outputs can run without runner doing any OCI fetches.
