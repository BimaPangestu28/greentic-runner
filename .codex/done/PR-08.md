# PR-08.md (greentic-runner)
# Title: Switch messaging/secrets/events execution to provider-core only (single concept)

## Goal
Make provider-core the **only** execution mechanism for messaging/secrets/events providers to avoid half-migration.

## Strategy
- Introduce a hard runtime flag (enabled by default in CI):
  - `GREENTIC_PROVIDER_CORE_ONLY=1`
- When enabled:
  - any attempt to use legacy typed provider protocol fails fast with a clear error
- Update built-in/example flows to use ProviderInvoke.

## Tasks
1. **Flow migration**
   - Update any internal flows/nodes that currently bind to legacy provider protocols:
     - messaging send/receive
     - secrets get/put
     - events publish
   - Replace with ProviderInvoke ops.
2. **Compatibility policy**
   - In non-strict local mode, you may keep a temporary adapter that maps legacy flow config → ProviderInvoke,
     but it MUST be invisible to users (no new public feature).
   - In CI strict mode, adapter must not be used.
3. **CI enforcement**
   - Enable `GREENTIC_PROVIDER_CORE_ONLY=1` in CI for runner tests
4. **E2E smoke**
   - Add tests proving:
     - secrets put/get via provider-core
     - messaging send via provider-core
     - events publish via provider-core

## Acceptance criteria
- There is only one supported provider mechanism in practice: provider-core.
- CI fails if legacy provider protocol is exercised.

## Codex: PR-08 exact-scope discovery + implementation plan (no follow-up questions)

You are overestimating PR-08. First, compute the *exact* scope from the repository, then implement only what is required to make provider-core the single supported provider mechanism for messaging/secrets/events.

### A) Scope discovery (MUST do first; output a concrete list)
1) Search for all runtime execution paths that currently handle messaging, secrets, and events. Use ripgrep and list:
   - files/modules that send/receive messages
   - files/modules that read/write secrets
   - files/modules that publish/subscribe events
   Include exact file paths and the function names used during execution.

2) Search for any legacy provider protocol usage (typed provider runtimes / WIT worlds / old adapters). If none exist, state clearly:
   - “No legacy typed provider runtime exists; only host-side adapters exist” (if true)
   - and therefore PR-08 scope is limited to routing those host-side adapters through provider-core invoke.

3) Identify “built-in/example flows” in this repo:
   - enumerate directories containing flow fixtures / examples / docs
   - list exact paths and how they are loaded/used in tests or docs

4) Identify existing tests that cover messaging/secrets/events. List:
   - unit tests
   - integration/e2e tests
   - fixtures/assets

### B) Define PR-08 “done” in the smallest complete way
PR-08 is DONE when all of the following are true:
1) `GREENTIC_PROVIDER_CORE_ONLY=1` causes a fail-fast error ONLY when the runner would otherwise use a non-provider-core mechanism for messaging/secrets/events (if any exist). If none exist, the flag becomes a no-op and must NOT break anything.
2) At least one deterministic smoke test per domain succeeds using provider-core:
   - secrets: invoke op "echo" OR "put/get" on dummy provider-core component (choose the simplest available in-repo)
   - messaging: invoke op "echo" OR "send" on dummy provider-core component
   - events: invoke op "echo" OR "publish" on dummy provider-core component
3) CI enables `GREENTIC_PROVIDER_CORE_ONLY=1` for these tests.

### C) Implementation rules (to avoid half-migrations)
- Do NOT ask which flows to migrate. Derive “built-in/example flows” from the repo and migrate only those that are actually used by tests/examples.
- Do NOT invent new adapters unless required to keep existing tests working.
- If the repo does not currently execute typed provider protocols, do NOT create fake “legacy” code just to gate it; instead:
  - ensure messaging/secrets/events execution uses ProviderInvoke (provider-core) where applicable,
  - or explicitly document that PR-08 only adds the CI flag + provider-core smoke coverage because no legacy provider runtime exists here.

### D) Deliverables (must commit in PR-08)
1) `docs/pr08_scope.md` containing:
   - list of discovered paths from A1–A4
   - the minimal change set chosen
2) Code changes implementing B1–B3.
3) Tests + fixtures built locally (no downloads).

Proceed now. If you believe something is ambiguous, resolve it by inspecting the repository rather than asking questions.
